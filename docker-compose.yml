# Development docker-compose — runs on HTTP (no TLS) for easy local development.
#
# Production TLS setup (choose one):
#
# Option A: Automatic certs via Let's Encrypt (ACME, TLS-ALPN-01)
#   1. Set API_HOSTNAME, CHAT_HOSTNAME, COOKIE_DOMAIN, ACME_CONTACT, LISTEN_ADDR=0.0.0.0:443
#   2. Ensure port 443 is directly reachable from the internet
#   3. Certs are cached in /config/acme/ (sovereign-config volume)
#   4. Use ACME_STAGING=true to test against staging endpoint first
#
# Option B: Manual TLS certs
#   1. Generate or obtain TLS certs and place them in ./config/
#   2. Add these environment variables:
#        TLS_CERT_PATH=/config/cert.pem
#        TLS_KEY_PATH=/config/key.pem
#        LISTEN_ADDR=0.0.0.0:443
#        API_HOSTNAME=api.example.com
#        CHAT_HOSTNAME=chat.example.com
#        COOKIE_DOMAIN=.example.com
#   3. Change ports mapping to "443:443"
#   4. See scripts/generate-dev-certs.sh for self-signed cert generation.
#
# Network architecture:
#   sovereign-public   — bridge network, proxy exposed to host
#   sovereign-internal — internal network, proxy ↔ backends only (no external access)
#
#   Backend containers (llama.cpp) are created programmatically via the Docker
#   API and attached to sovereign-internal. The proxy reaches them by container name
#   on port 8080.

services:
  proxy:
    build: .
    ports:
      - "${SE_PORT:-3000}:3000"
    networks:
      sovereign-public:
      sovereign-internal:
      # Open WebUI reaches the proxy via these aliases on the internal network.
      # Both subdomains resolve to the proxy container.
      sovereign-openwebui:
        aliases:
          - ${API_HOSTNAME:-proxy}
          - ${CHAT_HOSTNAME:-proxy}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data:/config
      - ${MODEL_HOST_PATH:-./models}:/models
    # Docker socket access for the non-root container user.
    # Override DOCKER_GID if your host uses a different GID (check: stat -c %g /var/run/docker.sock).
    group_add:
      - "${DOCKER_GID:-999}"
    environment:
      - LISTEN_ADDR=0.0.0.0:3000
      - DATABASE_URL=sqlite:///config/sovereign.db
      - API_HOSTNAME=${API_HOSTNAME:-localhost}
      - CHAT_HOSTNAME=${CHAT_HOSTNAME:-localhost}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-}
      - BOOTSTRAP_USER=${BOOTSTRAP_USER:-admin}
      - BOOTSTRAP_PASSWORD=${BOOTSTRAP_PASSWORD:-changeme}
      - BREAK_GLASS=${BREAK_GLASS:-false}
      - MODEL_PATH=/models
      - BACKEND_NETWORK=sovereign-internal
      - WEBUI_API_KEY=${WEBUI_API_KEY}
      - SECURE_COOKIES=false
      # - DB_ENCRYPTION_KEY=your-secret-key-here
      - RUST_LOG=${RUST_LOG:-sovereign_engine=info,tower_http=info}
      # ACME (Let's Encrypt) — set ACME_CONTACT to enable; domains derived from hostnames
      - ACME_CONTACT=${ACME_CONTACT:-}
      - ACME_STAGING=${ACME_STAGING:-}
    healthcheck:
      test: ["CMD-SHELL", "curl -skf https://localhost:3000/auth/providers || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # Open WebUI — chat interface proxied through Sovereign Engine at /.
  #
  # Auth: Trusted headers from the proxy (X-SE-User-Email, X-SE-User-Name).
  # Users authenticate via the portal's OIDC flow; no separate OIDC client needed.
  # The proxy injects identity headers after session validation.
  #
  # API key: Both containers share WEBUI_API_KEY. The proxy auto-provisions an
  # internal token at startup; Open WebUI uses it to call /v1 for inference.
  #
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    # No external ports — only accessible via the proxy on sovereign-internal
    networks:
      - sovereign-openwebui
    volumes:
      - ./data/open-webui:/app/backend/data
    environment:
      # OpenAI-compatible API — points to Sovereign Engine via openwebui network.
      # With ACME: set WEBUI_OPENAI_URL=https://<api-hostname>/v1 so TLS cert matches.
      - OPENAI_API_BASE_URL=${WEBUI_OPENAI_URL:-http://proxy:3000/v1}
      - OPENAI_API_KEY=${WEBUI_API_KEY}
      # Disable Ollama (not used — all models served via Sovereign Engine)
      - OLLAMA_BASE_URL=
      # Trusted header auth — proxy injects these after session validation
      - WEBUI_AUTH_TRUSTED_EMAIL_HEADER=X-SE-User-Email
      - WEBUI_AUTH_TRUSTED_NAME_HEADER=X-SE-User-Name
      # Disable local auth (all auth handled by proxy)
      - ENABLE_SIGNUP=true
      - ENABLE_LOGIN_FORM=false
      - DEFAULT_USER_ROLE=user
      # All models visible to all users — access control handled by Sovereign Engine tokens
      - BYPASS_MODEL_ACCESS_CONTROL=True
      - ENABLE_FORWARD_USER_INFO_HEADERS=True
    depends_on:
      - proxy
    restart: unless-stopped

networks:
  sovereign-public:
    name: sovereign-public
    driver: bridge
  sovereign-internal:
    name: sovereign-internal
    driver: bridge
    internal: true
  sovereign-openwebui:
    name: sovereign-openwebui
    driver: bridge
    internal: true

